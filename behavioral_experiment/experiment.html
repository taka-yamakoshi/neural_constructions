<!DOCTYPE html>
<html>
  <head>
    <title>Experiment</title>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <!-- <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script> -->
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <!-- <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script> -->
    <!-- <script src="jspsych-6.1.0/plugins/jspsych-survey-multi-choice.js"></script> -->
    <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>

    <script src="example_trials.js"></script>
  </head>
  <body></body>
  <script>
    var preview = {
      type: 'instructions',
      pages: ['<p> Welcome! In this HIT, you will make a series of quick decisions based on evidence. </p>' +
              '<p> <b> If you are interested in learning more about this HIT, ' +
              'please first accept the HIT in MTurk before continuing further</b>. </p>'],
      show_clickable_nav: false,
      allow_keys: false
    }

    var welcome = {
      type: 'html-keyboard-response',
      stimulus:
        'Thank you for accepting the HIT. Press any key to begin.'
    }

    var consent = {
      type: 'html-button-response',
      stimulus:
        "<font size='2'><p align=left style='width:50%;margin:auto'> \
	This research is being conducted by Takateru Yamakoshi, an undergraduate student, \
        Robert Hawkins, a postdoctoral \
        researcher, Adele Goldberg, and Tom Griffiths, faculty members at Princeton \
        University. This study takes approximately 10 minutes to complete.</p> \
        <br> \
        <p style='width:50%;margin:auto' align='left'>If you agree to take part in the research, you will make a series \
        of judgments about sentences. You will be \
        presented with information displayed as text and \
        will be asked to move a slider to express your judgment. \
        All of the information we obtain during the research will be kept \
        confidential, and not associated with your name in any way. However, \
	while the study is running it will be associated with your MTurk \
        worker id. Once the study is complete we will replace your worker id \
        with a random string.</p> \
        <br> \
        <p style='width:50%;margin:auto' align='left'>If you have any questions about this research, do not hesitate to \
        contact Robert Hawkins at hawkrobe@gmail.com. If you have any questions \
        about your rights or treatment as a participant in this research project, \
        please contact the Princeton Office for Research Integrity and Assurance \
        by phone at 609-258-0865 or by email at ria@princeton.edu.</p> \
        <br>\
        <p style='width:50%;margin:auto' align='left'>By consenting to participate, you acknowledge that you are 18 years \
        or older, have read this consent form, agree to its contents, and agree \
        to take part in this research. If you do not wish to consent, close \
        this page and return the HIT on Mechanical Turk.</p></font>",
      choices: ['I consent to participate.']
    }

    var catch_trial = {
      type: "html-slider-response",
      stimulus: "catch trial stimulus",
      prompt: "",
      labels: ['A is much more natural', 'about the same', 'B is much more natural'],
      slider_width: sliderWidthScale * screen.width,
      require_movement: true
    };

    window.onload = function() {
      setupGame();
    }

    window.onbeforeunload = function() {
      // Doesn't give prompt if leaving experiment after final trial or
      // failing three quiz attempts.
      var pComplete = jsPsych.progress()['percent_complete'];
      var trialType = jsPsych.currentTrial()['type'];
      if ((!turkInfo.previewMode) & (pComplete != 100) & ((Math.round(pComplete) != 33) || (trialType != 'survey-multi-choice'))) {
        return "Data will be lost if you leave the page, are you sure?";
      }
    };

    function setupGame () {
      var socket = io.connect();
      var timeline = [];

      // Values fixed for human experiments.
      var iterationName = 'prolificPilot0'
      var sliderWidthScale = 0.5
      var maxQuizAttempts = 3

      // Start building timeline when we hear from server
      socket.on('onConnected', function(mongoData) {
        console.log(mongoData)
        // get workerId, etc. from URL (so that it can be sent to the server)
        var turkInfo = jsPsych.turk.turkInfo();

        // Extract stick data from mongo
        var trials = mongoData.trials

        // if still in preview mode, tell them to accept first, otherwise show first slide
        if (!turkInfo.previewMode) {
          timeline.push(welcome);
          timeline.push(consent);
        } else {
          timeline.push(preview);
        }

        var ready_screen = {
          type: "html-button-response",
          stimulus:
          "<p>Ready to begin? </p>",
          choices: ['Begin']
        }

        timeline.push(ready_screen);
        
        var practice_stimulus_1 = "\
          <div style='margin-left:25%;text-align: left'>\
            <p>Which sentence sounds more natural, A or B?<br></p>\
            <p>A : Sandy filled the water into the cup.</p>\
            <p>B : Sandy filled the cup with the water.</p>\
          </div>";
        var practice_stimulus_2 = "\
          <div style='margin-left:25%;text-align: left'>\
            <p>Which sentence sounds more natural, A or B?<br></p>\
            <p>A : Sandy picked the book up.</p>\
            <p>B : Sandy picked up the book.</p>\
          </div>";

        var practice_trial_1 = {
          type: "html-slider-response",
          stimulus: practice_stimulus_1,
          prompt: "",
          labels: ['A is much more natural', 'about the same', 'B is much more natural'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true
        };
        timeline.push(practice_trial_1)

        var feed_back_1 = {
          type: 'html-keyboard-response',
          stimulus:"\
          <div>\
            <p>Thank you for your response.</p>\
            <p>Many people think sentence B (Sandy filled the cup with water) <br>\
            is more natural than sentence A (Sandy filled water into the cup),<br> \
            and would drag the slider further to the right side.</p>\
            <p>Press any key to move on to another practice question.</p>\
          </div>",
        };
        timeline.push(feed_back_1)

        var practice_trial_2 = {
          type: "html-slider-response",
          stimulus: practice_stimulus_2,
          prompt: "",
          labels: ['A is much more natural', 'about the same', 'B is much more natural'],
          slider_width: sliderWidthScale * screen.width,
          require_movement: true
        };
        timeline.push(practice_trial_2)

        var feed_back_2 = {
          type: 'html-keyboard-response',
          stimulus:"\
          <div>\
            <p>Thank you for your response. </p>\
            <p>Many people think both of these sentences <br>\
            (Sandy picked the book up, Sandy picked up the book) <br>\
            sound equally natural, and would place the slider closer to the middle.</p> \
            <p> Please keep in mind, however, that different sentences\
            may sound more or less natural to different people, so just tell us\
            what you think! </p>\
            <p>Press any key to begin the experiment.</p>\
          <div>",
        };
        timeline.push(feed_back_2)

        _.forEach(trials, function(trial) {
          var order = _.sample([true, false]);
          var sentenceA = order ? trial.DOsentence : trial.PDsentence;
          var sentenceB = order ? trial.PDsentence : trial.DOsentence;
          var sentence_stimulus = "\
            <div style='margin-left:25%;text-align: left'>\
              <p>Which sentence sounds more natural, A or B?<br></p>\
              <p>A : " + sentenceA + ".</p>\
              <p>B : " + sentenceB + ".</p>\
            </div>";
          var trial = {
            type: "html-slider-response",
            stimulus: sentence_stimulus,
            prompt: "",
            labels: ['A is much more natural', 'about the same', 'B is much more natural'],
            slider_width: sliderWidthScale * screen.width,
            require_movement: true
          };

          timeline.push(trial)
        })

	// Sample an index between timeline.length - 25 and timeline.length
	// timeline.splice(index, 0, catch_trial)
	    
        var exit_survey = {
          type: 'survey-text',
          questions: [
            {prompt: "Do you have any comments or suggestions?"}
          ],
          data: {
            stimulus_type: 'exit_survey'
          }
        };

        timeline.push(exit_survey)

        var goodbye = {
          type: 'html-keyboard-response',
          stimulus: 'Thank you for participating! Press any key to to be ' +
            'redirected to the completion page.'
        };

        timeline.push(goodbye);

	jsPsych.data.addProperties({
          gameid: mongoData.gameid,
	  setid: mongoData.set_id
        });

        jsPsych.init({
          timeline: timeline,
          show_progress_bar: true,
          on_finish : function(data) {
            // At the end of the experiment, submit to turk
            // Record number of quiz attempts
            // jsPsych.turk.submitToTurk({'value': 0});
            window.location.replace("https://app.prolific.co/submissions/complete?cc=394CC1E4")
            // jsPsych.data.displayData(); // Uncomment this line to debug
          },
          on_trial_finish: function(trialData) {
            // At the end of each trial, send data to server
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            var packet = Object.assign({}, trialData, {
              dbname: 'neural_constructions',
              colname: 'experiment',
              wID: urlParams.get('PROLIFIC_PID'),
              aID: urlParams.get('STUDY_ID'),
              hitID: urlParams.get('SESSION_ID'),
              iterationName: iterationName
            })

	    socket.emit('currentData', packet);
          }
        });
      });
    }
  </script>
</html>
